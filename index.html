<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Fedora API Specification</title>
    <meta charset='utf-8'>
    <meta name="description" content="Fedora API Specification">
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common'
            async class='remove'></script>
    <script class='remove'>
      var respecConfig = {
          specStatus: "unofficial",
          shortName:  "fedora-api",
          editors: [
                {   name:       "Ben Armintor",
                    company:    "Columbia University",
                    companyURL: "http://library.columbia.edu/"},
                {   name:       "Aaron Birkland",
                    company:    "Johns Hopkins",
                    companyURL: "http://www.library.jhu.edu/"},
                {   name:       "Aaron Coburn",
                    company:    "Amherst College",
                    companyURL: "https://www.amherst.edu/"},
                {   name:       "Sergio Fern√°ndez",
                    company:    "Redlink",
                    companyURL: "http://redlink.co/"},
                {   name:       "Tom Johnson",
                    company:    "Digital Public Library of America",
                    companyURL: "https://dp.la/"},
                {   name:       "Nick Ruest",
                    company:    "York University",
                    companyURL: "http://www.library.yorku.ca"},
                {   name:       "Rob Sanderson",
                    company:    "The Getty Trust",
                    companyURL: "http://www.getty.edu/"},
                {   name:       "Bethany Seeger",
                    company:    "Amherst College",
                    companyURL: "https://www.amherst.edu/library"},
                {   name:       "Adam Soroka",
                    company:    "University of Virginia",
                    companyURL: "https://www.virginia.edu/"},
                {   name:       "Simeon Warner",
                    company:    "Cornell University",
                    companyURL: "http://www.cornell.edu/"},
                {   name:       "Joshua Westgard",
                    company:    "University of Maryland",
                    companyURL: "http://www.lib.umd.edu/"},
                {   name:       "Jared Whiklo",
                    company:    "University of Manitoba",
                    companyURL: "http://umanitoba.ca"},
                {   name:       "Andrew Woods",
                    company:    "DuraSpace",
                    companyURL: "http://duraspace.org/"}
          ],
          edDraftURI: "http://fcrepo.github.io/fcrepo-specification/",
          testSuiteURI: "https://github.com/fcrepo/fcrepo-tcks",
          wg:           "Fedora Specification Working Group",
          wgURI:        "https://wiki.duraspace.org/display/FEDORAAPI/Fedora+Specification",
          wgPublicList: "https://groups.google.com/forum/#!forum/fedora-community",
          otherLinks: [{
            key: "Repository",
            data: [
              {
                value: "Github",
                href: "https://github.com/fcrepo/fcrepo-specification"
              },
              {
                value: "Issues",
                href: "https://github.com/fcrepo/fcrepo-specification/issues"
              },
              {
                value: "Commits",
                href: "https://github.com/fcrepo/fcrepo-specification/commits"
              }
            ]
          }],
          maxTocLevel: 3,
          logos: [{src: "http://fedora.info/assets/fedora_logo.png"}],
          overrideCopyright: "<p class='copyright'>This document is licensed under a <a class='subfoot' href='https://creativecommons.org/licenses/by/4.0/' rel='license'>Creative Commons Attribution 4.0 License</a>.</p>"
      };
    </script>
  </head>
  <body>
    <section id='abstract' class='informative'>
      <p>
        This specification refines the semantics and interaction patterns of [[LDP]] in order
        to better serve the specific needs of those interested in implementing or using the
        Fedora information architecture. Additionally, this specification contains:
      </p>
      <ul>
        <li>
          a reconciliation of [[LDP]] and the well-established version identification and
          navigation scheme delineated in the [[RFC7089]] specification,
        </li>
        <li>
          interaction patterns for use with binary fixity information,
        </li>
        <li>
          a scheme for assembling multiple operations against an [[LDP]] server into
          one atomic operation,
        </li>
        <li>
          integration with the <a href="https://www.w3.org/wiki/WebAccessControl">Web Access Control proposal,</a>
        </li>
        <li>
          and a design for the publication of asynchronous events emitted from an implementation.
        </li>
      </ul>
    </section>

    <section id="resource-management">
      <h2>Resource Management</h2>

      <section id="general">
        <h2>General</h2>
        <p>
          If a <code>Link: rel="type"</code> header specifies an LDP-NR interaction model
          (<code>ldp:NonRDFSource</code>), then the server SHOULD handle subsequent requests
          to the newly created resource as if it is a LDP-NR. ([[!LDP]] 5.2.3.4 extension)
        </p>
        <section id="LDPC">
          <h2>LDP Containers</h2>
          <p>
            Implementations MUST support the creation and management of [[!LDP]] Containers.
            LDP Direct Containers MUST NOT permit <code>ldp:contains</code> as their membership-predicate
            and requests that would so do MUST fail with 409 Conflict. ([[!LDP]] 5.4.1.4 expansion)
          </p>
        </section>
      </section>

      <section id="httpPATCH">
        <h2>HTTP PATCH</h2>
        <p>
          Any LDP-RS MUST support PATCH ([[!LDP]] 4.2.7 MAY becomes MUST). [[!sparql11-update]] MUST
          be an accepted content-type for PATCH. Other content-types (e.g. [[ldpatch]]) MAY be available.
          If an otherwise valid HTTP PATCH request is received that attempts to add statements to a
          resource that a server disallows (not ignores per [[!LDP]] 4.2.4.1), the server MUST fail
          the request by responding with a 4xx range status code (e.g. 409 Conflict). The server MUST
          provide a corresponding response body containing information about which statements could
          not be persisted. ([[!LDP]] 4.2.4.4 SHOULD becomes MUST). In that response the restrictions
          causing such a request to fail MUST be described in a resource indicated by a
          <code>Link: rel="http://www.w3.org/ns/ldp#constrainedBy"</code> response header per [[!LDP]] 4.2.1.6.
          A successful PATCH request MUST respond with a 2xx status code; the specific code in the 2xx
          range MAY vary according to the response body or request state.
        </p>
        <section id="httpPATCH-ixn-models">
          <h3>Interaction models</h3>
          <p>
            The server MUST disallow a PATCH request that would change the LDP interaction model of a
            resource to a type that is not a subtype of the current resource type. That request MUST be
            rejected with a 409 Conflict response.
          </p>
        </section>
      </section>

      <section id="httpPOST">
        <h2>HTTP POST</h2>
        <p>
          Any LDPC MUST support POST ([[!LDP]] 4.2.3 / 5.2.3). The default interaction model that
          will be assigned when there is no explicit Link header in the request MUST be recorded
          in the constraints document referenced in the <code>Link: rel="http://www.w3.org/ns/ldp#constrainedBy"</code>
          header ([[!LDP]] 4.2.1.6 clarification). Any LDPC MUST support creation of LDP-NRs on POST
          (LDP 5.2.3.3 MAY becomes MUST). On creation of an LDP-NR an implementation MUST create an
          associated LDP-RS describing that LDP-NR ([[!LDP]] 5.2.3.12 MAY becomes MUST).
        </p>
        <section id="httpPOSTLDPNR">
          <p>
            A HTTP POST request that would create a LDP-NR and includes a <code>Digest</code> header
            (as described in [[!RFC3230]]) for which the instance-digest in that header does not
            match that of the new LDP-NR MUST be rejected with a 409 Conflict response.
          </p>
          <p>
            A HTTP POST request that includes an unsupported <code>Digest</code> type (as described
            in [[!RFC3230]]), SHOULD be rejected with a 400 Bad Request response.
          </p>
          <p>
            Implementations SHOULD support <code>Content-Type: message/external-body</code> extensions for
            request bodies for HTTP <code>POST</code> that would create LDP-NRs. This content-type requires
            a complete <code>Content-Type</code> header that includes the location of the external body, e.g
            <code>Content-Type: message/external-body; access-type=URL; URL=\"http://www.example.com/file\"</code>,
            as defined in [[!RFC2017]].
          </p>
        </section>
      </section>

      <section id="httpPUT">
        <h2>HTTP PUT</h2>
        <p>
          When accepting a PUT request against an extant resource, an HTTP <code>Link: rel="type"</code>
          header MAY be included. If that type is a value in the LDP namespace and is not either a
          current type of the resource or a subtype of a current type of the resource, the request MUST be
          rejected with a 409 Conflict response. If the type in the Link header is a subtype of a current type
          of the resource, and has an interaction model assigned to it by [[!LDP]], then the resource MUST
          be assigned the new type and the interaction model of the resource MUST be changed to the
          interaction model assigned to the new type by [[!LDP]].
        </p>
        <section id="httpPUTLDPNR">
          <h2>LDP-NRs</h2>
          <p>
            Any LDP-NR MUST support PUT to replace the binary content of that resource.
          </p>
          <p>
            A HTTP PUT request that includes a <code>Digest</code> header (as described
            in [[!RFC3230]]) for which any instance-digest in that header does not match the instance
            it describes, MUST be rejected with a 409 Conflict response.
          </p>
          <p>
            A HTTP PUT request that includes an unsupported <code>Digest</code> type (as described
            in [[!RFC3230]]), SHOULD be rejected with a 400 Bad Request response.
          </p>
          <p>
            Implementations MUST support <code>Content-Type: message/external-body</code> extensions
            for request bodies for HTTP <code>PUT</code> to LDP-NRs. This content-type requires a
            complete <code>Content-Type</code> header that includes the location of the external body, e.g
            <code>Content-Type: message/external-body; access-type=URL; URL=\"http://www.example.com/file\"</code>,
            as defined in [[!RFC2017]].
          </p>
        </section>

        <section id="httpPUTLDPRS">
          <h2>LDP-RSs</h2>
          <p>
            Any LDP-RS MUST support PUT to update statements that are not server-managed triples
            (as defined in [[!LDP]] 2). [[!LDP]] 4.2.4.1 and 4.2.4.3 remain in effect. If an otherwise
            valid HTTP PUT request is received that attempts to add statements to a resource that a
            server disallows (not ignores per [[!LDP]] 4.2.4.1), the server MUST fail the request by
            responding with a 4xx range status code (e.g. 409 Conflict). The server MUST provide a
            corresponding response body containing information about which statements could not be
            persisted. ([[!LDP]] 4.2.4.4 SHOULD becomes MUST). In that response the restrictions
            causing such a request to fail MUST be described in a resource indicated by a
            <code>Link: rel="http://www.w3.org/ns/ldp#constrainedBy"</code> response header per [[!LDP]] 4.2.1.6.
          </p>
        </section>

        <section id="httpPUTcreate">
          <h2>Creating resources with HTTP PUT</h2>
          <p>
            An implementation MUST accept HTTP PUT to create resources.([[!LDP]] 4.2.4.6 MAY becomes
            MUST). The default interaction model that will be assigned when there is no explicit
            <code>Link: rel="type"</code> header in the request MUST be recorded in the constraints
            document referenced in the <code>Link: rel="http://www.w3.org/ns/ldp#constrainedBy"</code>
            header ([[!LDP]] 4.2.1.6 clarification).
          </p>
        </section>
      </section>

      <section id="httpGET">
        <h2>HTTP GET</h2>
        <p>
          When the request is to the LDP-RS created to describe a LDP-NR, the response MUST include
          a <code>Link: rel="describes"</code> header referencing the LDP-NR in question, as defined
          in [[!RFC6892]].
        </p>
        <section id="additionalPreferValues">
          <h2>Additional values for the <code>Prefer</code> header</h2>
          <p>
              In addition to the requirements of [[!LDP]], an implementation MAY support either or
              both of the following additional values for the <code>Prefer</code> header when making
              <code>GET</code> requests on LDPC resources:
          </p>
          <ul>
            <li>
              <code>http://fedora.info/definitions/repository#EmbedResources</code>:
              Requires a server to include representations of any contained resources in the response.
            </li>
            <li>
              <code>http://fedora.info/definitions/repository#InboundReferences</code>:
              Requires a server to include triples from any LDP-RS housed in that server that
              feature the requested resource as RDF-object.
            </li>
          </ul>
        </section>
        <section id="httpGETLDPNR">
          <h2>LDP-NRs</h2>
          <p>
            GET requests to any LDP-NR MUST correctly respond to the <code>Want-Digest</code> header
            defined in [[!RFC3230]] unless the <code>Content-Type</code> of the LDP-NR is a
            <code>message/external-body</code> extension.
          </p>
          <p>
            GET requests to a LDP-NR with <code>Content-Type: message/external-body</code>, MUST result
            in an HTTP 3xx redirect message redirecting to the external URL.
          </p>
          <section id="httpGETLDPNR-fixity-expectation">
            <h3><code>Expect: 202-digest</code></h3>
            <p>
              GET requests to a LDP-NR SHOULD respond to <code>Expect</code> request headers with a
              parameterized <a href="#202-digest"><code>202-digest</code></a> expectation. Implementations
              MAY support unparameterized <code>202-digest</code> expectations. Implementations that do not
              support one of these expectations MUST reject <a href="#202-digest">202-digest</a> requests
              for the expectation with a 417 Expectation Failed. If the LDP-NR is of
              <code>Content-Type: message/external-body</code>, the server MUST respond with a 3xx. If the
              digest parameter does not match the current instance digest of the resource, the request MUST
              be rejected with a 412 Precondition Failed. If the digest matches, the request MUST be
              completed with a 202 Accepted.
            </p>
            <section id="httpGETLDPNR-fixity-expectation-conneg" class="informative">
              <h4><code>Expect: 202-digest</code> and <code>Accept:</code></h4>
              <p>
                This specification takes no position on the interaction of <code>Expect: 202-digest</code>
                and <code>Accept:</code> headers on the same request, or on the meaning of the 406 Unacceptable
                status in that context. Implementations are not required to support combinations of these headers.
              </p>
            </section>
          </section>
        </section>
      </section>
    </section>

    <section id="resource-versioning">
      <h2>Resource Versioning</h2>
        <section id="terminology">
          <h2>Terminology</h2>
            <dl>
              <dt><dfn>LDPR</dfn>:</dt> <dd>An [[!LDP]] Resource. This may be an [[!LDP]] RDF Source or an [[!LDP]] Non-RDF Source.</dd>
              <dt><dfn>LDPRv</dfn>:</dt> <dd>A <a>LDPR</a> that is simultaneously a Memento <a>URI-R</a>.</dd>
              <dt><dfn>LDPRm</dfn>:</dt> <dd>A <a>LDPR</a> that is simultaneously a Memento <a>URI-M</a>.</dd>
              <dt><dfn>LDPC</dfn>:</dt> <dd>An [[!LDP]] Container.</dd>
              <dt><dfn>LDPCv</dfn>:</dt> <dd>A version container: an <a>LDPC</a> that is simultaneously a Memento <a>TimeMap</a>.</dd>
              <dt><dfn>URI-R</dfn>:</dt> <dd>A type of versioned resource defined in the Memento framework.</dd>
              <dt><dfn>URI-M</dfn>:</dt> <dd>A type of resource that is defined in the Memento framework as representing a version of a given <a>URI-R</a>.</dd>
              <dt><dfn>TimeGate</dfn>:</dt> <dd>A type of resource defined in the Memento framework providing <code>Accept-Datetime</code>-varied negotiation of versions of an <a>URI-R</a>.</dd>
              <dt><dfn>TimeMap</dfn>:</dt> <dd>A type of resource defined in the Memento framework that contains a machine-readable listing of <a>URI-M</a>s associated to a given <a>URI-R</a>.</dd>
            </dl>
        </section>

      <section>
        <h2>Versioned Resources (<a>LDPRv</a>)</h2>
        <section>
          <h2>General</h2>
          <p>
            A versioned resource for this document provides a <a>TimeGate</a> interaction model as
            detailed in the Memento specification and indicated by an HTTP header
            <code>Link: rel="timegate"</code> referencing itself. It otherwise follows the relevant
            [[!LDP]] specification with the additional behaviors below.
          </p>
        </section>

        <section id='httpget'>
          <h2>HTTP GET</h2>
          <section>
            <h2>Request Headers for an LDPRv</h2>
            <p>
              <code>Accept-Datetime</code>, exactly as per Memento.
            </p>
          </section>

          <section>
            <h2>Response Headers</h2>
            <p>
              At least one <code>Link: rel="timemap"</code> referencing an <a>LDPCv</a>. It is the
              presence of this header that indicates that the resource is versioned.
            </p>
            <p>
              <code>Vary: Accept-Datetime</code>, exactly as per Memento.
            </p>
          </section>
        </section>

        <section id='httpput'>
          <h2>HTTP PUT</h2>
          <section id="httpput-general">
            <h2>General</h2>
            <p>
              An <a>LDPRv</a> MAY support PUT. An implementation receiving a PUT request for an
              <a>LDPRv</a> MUST both correctly respond as per [[!LDP]] as well as create a new
              <a>LDPRm</a> contained in an appropriate <a>LDPCv</a>. The newly-created <a>LDPRm</a>
              SHOULD be the version of the <a>LDPRv</a> that was created by the <code>PUT</code> request.
            </p>
          </section>

          <section>
            <h2>Request Headers for an LDPRv</h2>
            <p>
              <code>Accept-Datetime</code>, exactly as per Memento.
            </p>
          </section>

          <section>
            <h2>Response Headers</h2>
            <p>
              At least one <code>Link: rel="timemap"</code> referencing a <a>LDPCv</a>. It is the
              presence of this header that indicates that the resource is versioned.
            </p>
            <p>
              <code>Vary: Accept-Datetime</code>, exactly as per Memento.
            </p>
          </section>
        </section>

        <section>
          <h2>HTTP HEAD</h2>
          <p>
            See: <a href='#httpget'></a>
          </p>
        </section>
      </section>

      <section>
        <h2>Version Resources (<a>LDPRm</a>)</h2>
        <section>
          <h2>General</h2>
          <p>
            When a <a>LDPR</a> is created with a <code>Link</code> header indicating versioning,
            it is created as both an LDP Resource and a Memento: a <a>LDPRm</a>. An <a>LDPRm</a>
            MUST be invariant: While it MAY be deleted, it MUST NOT be modified once created.
          </p>
        </section>

        <section>
          <h2>HTTP DELETE</h2>
          <p>
            An implementation MAY support <code>DELETE</code> for <a>LDPRm</a>s. If DELETE is
            supported, the server is responsible for all behaviors implied by the LDP-containment
            of the <a>LDPRm</a>.
          </p>
        </section>

        <section>
          <h2>HTTP GET</h2>
          <p>
            An implementation MUST support <code>GET</code>, as is the case for any <a>LDPR</a>.
            The headers for <code>GET</code> requests and responses on this resource MUST conform
            to [[!RFC7089]]. Particularly it should be noted that the relevant <a>TimeGate</a> for
            an <a>LDPRm</a> is the original versioned <a>LDPRv</a>.
          </p>
        </section>

        <section>
          <h2>HTTP HEAD</h2>
          <p>
            An implementation MUST support <code>HEAD</code>.
          </p>
        </section>

        <section>
          <h2>HTTP OPTIONS</h2>
          <p>
            An implementation MUST support <code>OPTIONS</code>. A response to an <code>OPTIONS</code>
            request MUST include <code>Allow: GET, HEAD, OPTIONS</code> as per [[!LDP]]. An
            implementation MAY include <code>Allow: DELETE</code> if clients can remove a version
            from the version history, as noted <a href="#h-http-delete">above</a>.
          </p>
        </section>

        <section>
          <h2>HTTP PATCH</h2>
          <p>
             An implementation MUST NOT support <code>PATCH</code> for <a>LDPRm</a>s.
          </p>
        </section>

        <section>
          <h2>HTTP POST</h2>
          <p>
            An implementation MUST NOT support <code>POST</code> for <a>LDPRm</a>s.
          </p>
        </section>

        <section>
          <h2>HTTP PUT</h2>
          <p>
             An implementation MUST NOT support <code>PUT</code> for <a>LDPRm</a>s.
          </p>
        </section>

      </section>

      <section>
        <h2>Version Containers (<a>LDPCv</a>)</h2>
        <section>
          <h2>General</h2>
          <p>
            When a <a>LDPR</a> is created with a <code>Link</code> header indicating versioning, a
            version container (<a>LDPCv</a>) is created that contains Memento-identified resources
            (<a>LDPRm</a>) capturing time-varying representations of the associated <a>LDPR</a>. An
            <a>LDPCv</a> is both a <a>TimeMap</a> per [[!RFC7089]] (Memento) and an LDP Container.
            As a <a>TimeMap</a> an <a>LDPCv</a> MUST conform to the specification for such resources
            in [[!RFC7089]]. An implementation MUST indicate <a>TimeMap</a> in the same way it
            indicates the Container interaction model of the resource via HTTP headers. An <a>LDPCv</a>
            MUST respond to <code>GET Accept: application/link-format</code> as indicated in [[!RFC7089]]
            <a href='https://tools.ietf.org/html/rfc7089#section-5'>section 5</a> and specified in
            [[!RFC6690]] <a href='https://tools.ietf.org/html/rfc6690#section-7.3'>section 7.3</a>.
          </p>
          <p>
            An implementation MUST NOT allow the creation of an <a>LDPCv</a> that is LDP-contained
            by its associated <a>LDPRv</a>.
          </p>
          <p>
            Non-normative: The <code>application/link-format</code> representation of a <a>LDPCv</a>
            is not required to include all statements in the <a>LDPCv</a> graph, only those required
            by <a>TimeMap</a> behaviors.
          </p>
        </section>

        <section>
          <h2 id='ldpcvdelete'>HTTP DELETE</h2>
          <p>
            An implementation MAY support <code>DELETE</code>. An implementation that does support
            <code>DELETE</code> SHOULD do so by both removing the <a>LDPCv</a> and removing the
            versioning interaction model from the original <a>LDPRv</a>.
          </p>
        </section>

        <section>
          <h2>HTTP OPTIONS</h2>
          <p>
            An implementation MUST <code>Allow: GET, HEAD, OPTIONS</code> as per [[!LDP]]. An
            implementation MAY <code>Allow: DELETE</code> if the versioning behavior is removable
            by deleting the <a>LDPCv</a>. See <a href='#ldpcvdelete'></a> for requirements on
            DELETE if supported.
          </p>
          <p>
            An implementation MAY <code>Allow: PATCH</code> if the <a>LDPCv</a> has mutable properties.
            See <a href='#ldpcvpatch'></a> for requirements on <code>PATCH</code> if supported.
          </p>
          <p>
            An implementation MAY <code>Allow: POST</code> if versions can be explicitly minted by a
            client. See <a href='#ldpcvpost'></a> for requirements on <code>POST</code> if supported.
          </p>
        </section>

        <section>
          <h2 id='ldpcvpatch'>HTTP PATCH</h2>
          <p>
            An implementation MAY <code>Allow: PATCH</code>, but if so, it MUST NOT permit clients
            to modify containment triples.
          </p>
        </section>

        <section>
          <h2 id='ldpcvpost'>HTTP POST</h2>
          <p>
            If a <a>LDPCv</a> supports <code>POST</code>, <code>POST</code> SHOULD be understood to
            create a new <a>LDPRm</a> contained by the <a>LDPCv</a>, reflecting the state of the
            <a>LDPRv</a> at the time of the <code>POST</code>. If supported, but the representation
            at the time of version creation can only be that which is current for the <a>LDPRv</a>,
            the <code>Accept-Post</code> header of any response from the <a>LDPCv</a> SHOULD indicate
            that no request body is accepted via the form <code>Accept-Post: */*; p=0.0</code>, and
            that implementation SHOULD respond to any body-containing <code>POST</code> to that
            <a>LDPCv</a> with a 415 response and a link to an appropriate constraints document
            (see <a href='https://www.w3.org/TR/ldp/#h-ldpr-gen-pubclireqs'>LDP 4.2.1.6</a>). As per
            [[!LDP]], any resource created via <code>POST</code>, in this case a <a>LDPRm</a>)
            SHOULD be advertised in the response's <code>Location</code> header.
          </p>
          <p>
            If a <a>LDPCv</a> does accept <code>POST</code> with a request body, it SHOULD respect
            a <code>Memento-Datetime</code> request header for the created <a>LDPRm</a>.
            Absent this header, it MUST use the current time.
          </p>
          <p>
            Non-normative note: If an <a>LDPCv</a> does not <code>Allow: POST</code>, the constraints
            document indicated in <code>Link: rel="http://www.w3.org/ns/ldp#constrainedBy"</code> for
            that <a>LDPCv</a> should describe the versioning mechanism (e.g. by <code>PUT</code> or
            <code>PATCH</code> to the <a>LDPRv</a> described by that <a>LDPCv</a>). Disallowing
            <code>POST</code> suggests that the [[!LDP]] server will manage all <a>LDPRm</a>
            creation; see <a href ="#server-managed">here</a>.
          </p>
        </section>

      </section>

      <section>
        <h2 class='informative'>Vary</h2>
        <p>
          When a <code>POST</code> to an <a>LDPCv</a> or <code>PUT</code> or <code>PATCH</code> to
          an <a>LDPRv</a> creates a new <a>LDPRm</a>, the response indicates that using a
          <code>Vary</code> header as appropriate. When a <a>LDPCv</a> supports  <code>POST</code>,
          and allows clients to specify a datetime for created <a>URI-M</a>s,
          Vary-Post/Vary-Put: Memento-Datetime.
        </p>
      </section>

      <section>
        <h2 class='informative'>Implementation Patterns</h2>

        <section>
          <h2>Introduction</h2>
          <p>
            This is a non-normative section describing the way the normative specification might be
            applied to implement discoverable versioning patterns. If an implementation of a
            <a>LDPCv</a> does not support <code>POST</code> to mint versions, that must be advertised
            via <code>OPTIONS</code> as described above. The implementation may automatically mint
            versions instead, but that is outside the requirements of this specification. This
            document specifies normatively only how <a>LDPCv</a>s and <a>LDPRm</a>s can be
            discovered, and how they should act.
          </p>
        </section>

        <section>
          <h2><a>LDPRm</a> Creation Patterns</h2>
          <section id="server-managed">
            <h2>Server-Managed Version Creation</h2>
            <p>
              Upon <code>PUT</code> or <code>PATCH</code> to the <a>LDPRv</a>, a new <a>LDPRm</a>
              is created in an appropriate <a>LDPCv</a>. This <a>LDPRm</a> is the version of the
              original <a>LDPRv</a> that was just created.
            </p>
          </section>

          <section id="client-managed">
            <h2>Client-Managed Version Creation</h2>
            <p>
              An <a>LDPRm</a> for a particular <a>LDPRv</a> is created on <code>POST</code> to any
              <a>LDPCv</a> associated with that <a>LDPRv</a>. The new <a>LDPRm</a> is contained in
              the <a>LDPCv</a> to which the <code>POST</code> was made and features in that
              <a>LDPCv</a>-as-a<a>TimeMap</a> . This pattern is more open to manipulation and could
              be useful for migration from other systems into Fedora implementations. Responses from
              requests to the <a>LDPRv</a> include a <code>Link: rel="timemap"</code> to the same
              <a>LDPCv</a> as per [[!RFC7089]].
            </p>
          </section>
        </section>
      </section>
    </section>

    <section id="binary-fixity">
      <h2>Binary Resource Fixity</h2>
      <section id="what-is-fixity" class="informative">
        <h2>What is fixity?</h2>
        <p>
          For the purposes of the following specification, a fixity result is an extract or summary
          of some LDPNR made according to some explicit procedure. Fixity results are taken for the
          purpose of comparing different fixity results for the same resource over time, to ensure
          a continuity of that resource's identity according to the particular procedure used.
          Examples might include:
        </p>
        <ul>
          <li>Checksums like MD5 or SHA1, often used for digital images.</li>
          <li><a href="https://www.w3.org/TR/xmldsig-core/">XML Signatures</a></li>
          <li>Per-segment results <a href="http://dericed.com/papers/reconsidering-the-checksum-for-audiovisual-preservation/">as used for time-based media</a></li>
        </ul>
        <p>
          This specification describes two fixity verification mechanisms: firstly, as part of
          content transmission, to guard against faults in transmission, and secondly, by comparison
          to a known or proffered digest value, to monitor for faults in persistence.
        </p>
      </section>
      <section id="transmission-fixity" class="informative">
        <h2>Transmission Fixity</h2>
        <p>
          Transmission fixity is verified by application of the <code>Digest</code> header
          defined in [[RFC3230]] to POST and PUT requests for LDP-NR.
        </p>
      </section>

      <section id="persistence-fixity">
        <h2>Persistence Fixity</h2>
        <section id="persistence-fixity-preamble" class="informative">
          <p>
            In the minimal case, a client that has an original digest value can verify persistence
            fixity by downloading the LDP-NR and calculating the checksum. To avoid the necessity
            of transferring a potentially large binary, this specification describes a new expectation
            token for the <code>Expect</code> header described in [[RFC7231]]: <code>202-digest</code>,
            and a <code>digest-link</code> parameter.
          </p>
        </section>
        <section id="202-digest">
          <h3>Expect: 202-digest</h3>
          <p>
            The <code>202-digest</code> expectation indicates that the client is requesting that
            the server verify an instance digest for the resource at the request URI.
          </p>
          <pre><code>
            Expect                  =  "Expect" ":" 1#digest-expectation
            digest-expectation      = "202-digest" [(digest-param|digest-link-param)]
            digest-param            = ";" #(instance-digest)
            digest-link-param       = ";" "digest-link" "=" URI-reference
          </code></pre>
          <p>
            <code>instance-digest</code> values are of the syntax described in [[!RFC3230]] for the
            <code>Digest</code> header. <code>URI-reference</code> values for the
            <code>digest-link-param</code> are described in [[!RFC2396]].
          </p>
          <p>
            HTTP/1.1 servers that do not support the 202-digest expectation MUST reject requests
            with 417 Expectation Failed.
          </p>
          <p>
            An implementing server MAY allow <code>202-digest</code> without a <code>digest-param</code>,
            indicating that the compared and calculated digests are selected by the server. Such servers
            SHOULD compare the calculated instance digest to a stored original digest. Servers that require
            a client-proffered <code>digest-param</code> MUST reject requests without a digest with
            417 Expectation Failed.
          </p>
          <p>
            If the compared digests do not match, an implementing server MUST reject the request with
            412 Precondition Failed. If the compared digests match, an implementing server MUST complete
            the request with 202 Accepted. A 200 OK status indicates that the server did not understand
            the request, and ignored the expectation.
          </p>
          <p>
            An implementing server SHOULD accompany HTTP status 417 and 412 responses with an
            explanatory entity.
          </p>
        </section>
        <section id="202-digest-ignored" class="informative">
          <h3>Ignored Expectations and 200 (OK)</h3>
          <p>
            A client aware of <code>202-digest</code> that receives a 200 should assume it is responsible
            for verifying fixity by downloading the resource.
          </p>
        </section>
        <section id="202-digest-link" class="informative">
          <h3>Complex Fixity and the digest-link parameter</h3>
          <p>
            Digital preservationists acknowledge the
            <a href="http://dericed.com/papers/reconsidering-the-checksum-for-audiovisual-preservation/">limits of simple bit fixity verification</a>
            to describe the state of some types of resources, eg large media files. Servers that can
            support more sophisticated assessments of content difference may use the
            <a href="#202-digest">202-digest expectation</a> with a <code>digest-link</code> parameter
            identifying a more appropriate verification of such resources, with 412 responses
            accompanied by appropriate explanatory entities.
          </p>
        </section>
      </section>
    </section>

    <section id="resource-authorization">
      <h2>Resource Authorization</h2>
      <p>
        To configure access control restrictions, implementations MUST follow the recommendations
        of [[!SOLIDWEBAC]].
      </p>
      <p>
        Implementations supporting access control MUST use the [[!WEBAC]] model to
        configure that functionality. Any access control resource in use MUST be a LDP-RS,
        which SHOULD be located in the same server as the controlled resource. Implementations
        MUST support extended control relationships in which the access control resource for some
        resource has its own access control resource and so on. Implementations MUST make access
        control resources discoverable via the <code>Link: rel="acl"</code> HTTP header, as discussed
        <a href="https://github.com/solid/web-access-control-spec#acl-resource-location-discovery">here</a>.
      </p>

      <section id="inheritance">
        <h2>Inheritance</h2>
        <p>
          An implementation MUST respect [[!LDP]]-containment for access control, as described
          <a href="https://github.com/solid/web-access-control-spec#acl-inheritance-algorithm">here</a>.
        </p>
      </section>
    </section>

    <section id ="atomic-operations">
      <h2>Atomic Operations</h2>

      <section id="atomic-operations-introduction" class="informative">
        <h2>Introduction</h2>
        <p>
          Fedora provides factilities by which to conduct multiple operations against a repository
          in an atomic fashion. This is accomplished by the use of headers on requests. An atomic
          series of operations should not require any more requests than the same series of
          operations performed non-atomically.
        </p>
      </section>

      <section id="begin">
        <h2>Beginning an atomic series of operations</h2>
        <p>
          A client begins an atomic series of requests by sending any request to any resource with
          the header <code>Atomic-Start</code>. The server MUST respond by including a header
          <code>Atomic-ID</code> with a unique identifier for the series. The effect of the
          request, if it has one, and if the request is successful, MUST be visible to clients
          using that identifier to add to this series of requests, as described
          <a href="#adding">below</a>, until the series expires or is finished. The effect of the
          request, if it has one, and if the request is successful, SHOULD NOT be visible to
          clients not using that identifier to add to this series of requests. The effect of the
          request MUST NOT be durable unless and until the series is successfully
          <a href="#commit">finished</a>.
        </p>
      </section>

      <section id="adding">
        <h2>Adding to an atomic series of operations</h2>
        <p>
          A client adds to an atomic series of requests by sending any request to any resource with
          the header <code>Atomic-ID</code> and the identifier for that series. The effect of the
          request, if it has one, and if the request is successful, MUST be visible to clients
          using that identifier to add to this series of requests, until the series expires or is
          finished. The effect of the request, if it has one, and if the request is successful,
          SHOULD NOT be visible to clients not using that identifier to add to this series of
          requests. The effect of the request MUST NOT be durable unless and until the series is
          successfully <a href="#commit">finished</a>. An implementation MUST respond
          to any request with multiple <code>Atomic-ID</code> headers with different values or
          with an <code>Atomic-ID</code> header with a value that has not been assigned to a
          series or that has expired (see <a href="#expiration">below</a>) with a 409 response.
          That response MUST include an <code>Atomic-Invalid</code> header or headers with the
          invalid identifier or identifiers.
        </p>
      </section>

      <section id="expiration">
        <h2>Expiration</h2>
        <p>
          An implementation MAY enforce automatic expiration for an atomic series of requests.
          If so, the response to any request made as part of the series MUST have a
          <code>Atomic-Expires</code> header with the HTTP datetime at which the series will
          expire. An implementation MAY extend the lifetime of a series upon the receipt of any
          request specifying the unique identifier of that series in the <code>Atomic-ID</code>
          header.
        </p>
      </section>

      <section id="commit">
        <h2>Committing a series</h2>
        <p>
          A client can finish an atomic series of requests by sending any
          <code>PUT</code>/<code>POST</code>/<code>PATCH</code>/<code>DELETE</code> request
          including both a <code>Atomic-Commit</code> header and a <code>Atomic-ID</code>
          header with the unique identifier of an existing series. The effects of all requests
          in the series MUST become durable and MUST become visible to all clients. The unique
          identifier of the series MUST be expired and MUST NOT be reused.
        </p>
      </section>

      <section id="abort">
        <h2>Aborting a series</h2>
        <p>
          A client can finish an atomic series of requests by sending any request including
          both a <code>Atomic-Abort</code> header and a <code>Atomic-ID</code> header with
          the unique identifier of an existing series. The effects of all requests in the
          series MUST disappear to all clients, and MUST be durably gone. The unique identifier
          of the series MUST be expired and MUST NOT be reused.
        </p>
      </section>
    </section>

    <section id="messaging">
      <h2>Messaging</h2>
      <section class="informative">
        <h3>Introduction</h3>
        <p>
          This section defines when messages are emitted by a Fedora
          implementation, the minimal set of data contained in those messages and how
          those data are serialized. These messages may occur synchronously or asynchronously
          with the API operations that cause them to be emitted. They are typically used to
          support external integrations. The structure of these messages draws upon the
          existing [[activitystreams-core]] and [[ldn]] specifications.
          An implementation is free to choose from any messaging technology so long as
          the messages conform to what is described in the following sections.
        </p>
      </section>

      <section id="emitting-messages">
        <h3>Emitting Messages</h3>
        <p>
          Any operation that causes the state of a resource to durably change MUST cause a
          message to be emitted with a corresponding resource identifier.
        </p>
        <p>
          In the context of a batch operation, messages MUST NOT be emitted until after all
          operations have been successfully committed.
        </p>
        <p>
          A failed operation (HTTP 4xx or 5xx) MUST NOT emit any messages.
        </p>
        <p>
          Messages MUST NOT be emitted until after any changes have been persisted to durable storage.
        </p>
        <p>
          Repository start, stop and configuration change operations MAY cause a message to be emitted.
        </p>
        <p>
          Any operation on an <a>LDPR</a> that results in a change to the containment or membership
          triples of a distinct other <a>LDPR</a> MUST also trigger an event for that other <a>LDPR</a>.
        </p>
        <p>
          Any operation that causes contained resources to change MUST trigger corresponding
          events for those resources. For example, deleting a parent resource and thereby
          changing the state of its child resources MUST result in corresponding events for
          each of the contained child resources.
        </p>
        <p>
          Non-normative: consumers of these messages should not expect a strict ordering of
          the events reported therein: the fact that a message for Event A is received before
          a message for Event B should not imply that Event A occurred before Event B.
          Implementations may choose to make further guarantees about ordering.
        </p>
      </section>

      <section id="message-data">
        <h3>Message Data</h3>
        <p>
          Emitted events MUST contain exactly one value for each of the following elements:
        </p>
        <ul>
          <li>Resource Identifier: the URI of the <a>LDPR</a> that was added, changed or removed.</li>
          <li>
            Timestamp: a timestamp marking the time of the event. The value of the timestamp
            SHOULD correspond to the time the resource was added/modified/deleted, but there is no
            strict requirement about the precision of this value. If the operation in question
            occurred as part of an atomic operation, the timestamps SHOULD correspond to the time
            the individual operation was performed (and not to the time the atomic operation
            was completed).
          </li>
          <li>Event identifier: a unique identifier for this event.</li>
        </ul>
        <p>
          A message MUST contain at least one value for the event type. Event types SHOULD be drawn
          from the [[!activitystreams-vocabulary]].
        </p>
        <p>
          A message SHOULD contain at least one value for the agent operating on the resource.
        </p>
        <p>
          A message SHOULD contain a collection of RDF types corresponding to the resource that
          was changed.
        </p>
        <p>
          If the corresponding <a>LDPR</a> includes an <code>ldp:inbox</code>, the location of
          that inbox SHOULD be included in the message.
        </p>
        <p>
          Messages SHOULD NOT contain the entire content of repository resources.
        </p>
      </section>

      <section id="message-serialization">
        <h3>Message Serialization</h3>
        <p>
          The message body serialization MUST conform to the [[!activitystreams-core]] specification.
        </p>
        <p>
          Wherever possible, data SHOULD be expressed using the [[!activitystreams-vocabulary]].
        </p>
      </section>

      <section id="message-examples">
        <h3>Examples</h3>
        <p>
          <em>This section is non-normative.</em>
        </p>
        <section id="minimal-message-example">
          <h4>A minimal message</h4>
          <div class="example">
            <pre class="json">
{
  "@context": [
    "https://www.w3.org/ns/activitystreams",
    {
      "date": {
        "@id": "http://purl.org/dc/terms/date",
        "@type": "xsd:dateTime"
      }
    }
  ],
  "id": "urn:uuid:3c834a8f-5638-4412-aa4b-35ea80416a18",
  "type": "Create",
  "name": "Resource Creation",
  "date": "2016-05-19T17:17:39Z",
  "actor": [
    {
      "id": "#actor0",
      "type": "Person",
      "name": "fedo raAdmin"
    },
    {
      "id": "#actor1",
      "type": "Application",
      "name": "FcrepoClient/0.1"
    }
  ],
  "object": {
    "id": "http://example.org/fcrepo/rest/resource/path",
    "type": [
      "ldp:Container",
      "ldp:RDFSource"
    ]
  }
}
            </pre>
          </div>
        </section>

        <section id="basic-message-example">
          <h4>A basic event with some additional detail</h4>
          <div class="example">
            <pre class="json">
{
  "@context": [
    "https://www.w3.org/ns/activitystreams",
    {
      "date": {
        "@id": "http://purl.org/dc/terms/date",
        "@type": "xsd:dateTime"
      },
      "isPartOf": {
        "@id": "http://purl.org/dc/terms/date",
        "@type": "@id"
      }
    }
  ],
  "id": "urn:uuid:be29ae69-2134-f1b0-34be-2f91b6d1f029",
  "type": "Update",
  "name": "Resource Modification",
  "date": "2016-07-04T13:46:39Z",
  "inbox": "http://example.org/ldn/inbox/path",
  "actor": [
    {
      "id": "#actor0",
      "type": "Person",
      "name": "fedo raAdmin"
    },
    {
      "id": "#actor1",
      "type": "Service",
      "name": "APIX-core/0.1"
    }
  ],
  "object": {
    "id": "http://example.org/fcrepo/rest/resource/path",
    "type": [
      "ldp:Container",
      "ldp:RDFSource",
      "http://example.org/type/CustomType"
    ],
    "isPartOf": "http://example.org/fcrepo/rest/"
  }
}
            </pre>
          </div>
        </section>
      </section>
    </section>

    <section class='appendix'>
      <h2>Acknowledgments</h2>
      <p>
      </p>
    </section>
  </body>
</html>
