<!DOCTYPE html>
<html>
  <head>
    <title>Fedora API Specification - Resource Versioning</title>
    <meta charset='utf-8'>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common'
            async class='remove'></script>
    <script class='remove'>
      var respecConfig = {
          specStatus: "unofficial",
          shortName:  "fedora-versioning",
          editors: [
                {   name:       "Adam Soroka",
                    company:    "University of Virginia",
                    companyURL: "https://www.library.virginia.edu/" },
                {   name:       "Ben Armintor",
                    company:    "Columbia University",
                    companyURL: "http://library.columbia.edu/" },
                {   name:       "Andrew Woods",
                    company:    "DuraSpace",
                    companyURL: "http://duraspace.org/" },
                {   name:       "Aaron Birkland",
                    company:    "Johns Hopkins",
                    companyURL: "http://www.library.jhu.edu/"},
                {   name:       "Bethany Seeger",
                    company:    "Amherst College",
                    companyURL: "https://www.amherst.edu/library"},
                {   name:       "Jared Whiklo",
                    company:    "University of Manitoba",
                    companyURL: "http://umanitoba.ca"},
                {   name:       "Joshua Westgard",
                    company:    "University of Maryland",
                    companyURL: "http://www.lib.umd.edu/"},
                {   name:       "Rob Sanderson",
                    company:    "The Getty Trust",
                    companyURL: "http://www.getty.edu/"},
                {   name:       "Sergio Fernández",
                    company:    "Redlink",
                    companyURL: "http://redlink.co/"},
                {   name:       "Tom Johnson",
                    company:    "Digital Public Library of America",
                    companyURL: "https://dp.la/"}
          ],
          edDraftURI: "https://github.com/fcrepo/fcrepo-specification/",
          testSuiteURI: "https://github.com/fcrepo/fcrepo-tcks",
          wg:           "Fedora Specification Working Group",
          wgURI:        "https://wiki.duraspace.org/display/FEDORAAPI/Fedora+Specification",
          wgPublicList: "https://groups.google.com/forum/#!forum/fedora-community",
          otherLinks: [{
            key: "Version history:",
            data: [{
              value: "Commit History.",
              href: "https://github.com/fcrepo/fcrepo-specification/commits/"
              }
          ]}]
      };
    </script>
  </head>
  <body>
    <section id='abstract' class='informative'>
      <p>
        This specification is an attempt to reconcile the semantics and client patterns of [[!LDP]], the versioning requirements of Fedora repositories, and the well-established version identification and navigation scheme delineated in the [[!rfc7089]] specification.
      </p>
    </section>

    <section id='sotd'>
    </section>
    
    <section>
      <h2>Terminology</h2>
      <p>
        <dl>
          <dfn>LDPR</dfn>:
          <dd> A Linked Data Platform Resource. This may be an LDP RDF Source or an LDP Non-RDF Source.</dd>
          <dfn>LDPRm</dfn>:
          <dd>A <a>LDPR</a> that is a version of an <a>LDP-Rv</a> resource. An <a>LDP-Rm</a> is both an <a>LDPR</a> and a Memento <a>URI-M</a> and contained by an <a>LDP-Cv</a>.</dd>
          <dfn>LDPRv</dfn>: 
          <dd>A <a>LDPR</a> that is versioned.Synonymous with Memento <a>URI-R</a>.</dd>
          <dfn>LDPC</dfn>: 
          <dd>A Linked Data Platform Container.</dd>
          <dfn>LDPCv</dfn>: 
          <dd>A Linked Data Platform Version Container. An <a>LDPCv</a> is both an <a>LDPC</a> and a <a>TimeMap</a>.</dd>
          <dfn>URI-R</dfn>: 
          <dd>A type of versioned resource defined in the Memento framework.</dd>
          <dfn>URI-M</dfn>: 
          <dd>A type of resource that is defined in the Memento framework representing a version of a given <a>URI-R</a>.</dd>
          <dfn>TimeGate</dfn>: 
          <dd>A type of resource defined in the Memento framework providing <code>Accept-Datetime</code> -varied negotiation of versions of an <a>URI-R</a>.</dd>
          <dfn>TimeMap</dfn>: 
          <dd>A type of resource defined in the Memento framework that contains a machine-readable listing of <a>URI-M</a>s connected to a given <a>URI-R</a>.</dd>
        </dl>
      </p>
    </section>
    
    <section id='conformance'>
    </section>
    
    <section>
      <h2>Versioned Resources (<a>LDPRv</a>)</h2>
      <section>
        <h2>General</h2>
        <p>
          A versioned resource for this document provides a <a>TimeGate</a> interaction model as detailed in the Memento specification and indicated by an HTTP header <code>Link@rel="timegate"</code> referencing itself. It otherwise follows the relevant [[!LDP]] specification with the additional behaviors below.
        </p>
      </section>
      <section id='httpget'>
        <h2>HTTP GET</h2>
        <section>
          <h2>Request Headers for an LDPRv</h2>
          <p>
            <code>Accept-Datetime</code>, exactly as per Memento.
          </p>
        </section>
        <section>
          <h2>Response Headers</h2>
          <p>
            At least one <code>Link@rel="timemap"</code> referencing a <a>LDP-Cv</a>. It is the presence of this header that indicates that the resource is versioned.
          </p>
          <p>
            <code>Vary: Accept-Datetime</code>, exactly as per Memento.
          </p>
        </section>
      </section>
      <section id='httpput'>
        <h2>HTTP PUT</h2>
		<section id="general">
			<h2>General</h2>
			<p>An <a>LDPRv</a> MAY support PUT. An implementation receiving a PUT request for an <a>LDPRv</a> must both correctly respond as per [[!LDP]] as well as create a new <a>LDPRm</a> contained in an appropriate <a>LDPCv</a>. The newly-created <a>LDPRm</a> should be the version of the <a>LDPRv</a> that was created by the <code>PUT</code> request.</p>
		</section>
        <section>
          <h2>Request Headers for an LDPRv</h2>
          <p>
            <code>Accept-Datetime</code>, exactly as per Memento.
          </p>
        </section>
        <section>
          <h2>Response Headers</h2>
          <p>
            At least one <code>Link@rel="timemap"</code> referencing a <a>LDPCv</a>. It is the presence of this header that indicates that the resource is versioned.
          </p>
          <p>
            <code>Vary: Accept-Datetime</code>, exactly as per Memento.
          </p>
        </section>
      </section>

      <section>
        <h2>HTTP HEAD</h2>
        <p>
          See: <a href='#httpget'></a>
        </p>
      </section>
    </section>

    <section>
      <h2>Version Resources (<a>LDPRm</a>)</h2>
      <section>
        <h2>General</h2>
        <p>
          When a <a>LDPR</a> is created with a <code>Link</code> header indicating versioning, it is created as both an LDP Resource and a Memento: a <a>LDPRm</a>. An <a>LDPRm</a> SHOULD be invariant: While it may be deleted, it SHOULD NOT be modified once created.
        </p>
      </section>

      <section>
        <h2>HTTP DELETE</h2>
        <p>
          An implementation MAY support <code>DELETE</code> for <a>LDPRm</a>s. If DELETE is supported, the Fedora/[[LDP]] server is responsible for all behaviors implied by the LDP-containment of the <a>LDPRm</a>.
        </p>
      </section>

      <section>
        <h2>HTTP GET</h2>
        <p>
          An implementation MUST support <code>GET</code>, as is the case for any <a>LDPR</a>. The headers for <code>GET</code> requests and responses on this resource must conform to [[!rfc7089]]. Particularly it should be noted that the relevant <a>TimeGate</a> for an <a>LDPRm</a> is the original versioned <a>LDPRv</a>.
        </p>
      </section>

      <section>
        <h2>HTTP HEAD</h2>
        <p>
          An implementation MUST support <code>HEAD</code>.
        </p>
      </section>

      <section>
        <h2>HTTP OPTIONS</h2>
        <p>
          An implementation MUST support <code>OPTIONS</code>. A response to an <code>OPTIONS</code> request must include <code>Allow: GET, HEAD, OPTIONS</code> as per [[LDP]].
          An implementation MAY include <code>Allow: DELETE</code> if clients can remove a version from the version history.
        </p>
      </section>

      <section>
        <h2>HTTP PATCH</h2>
        <p>
           An implementation MUST NOT support <code>PATCH</code> for <a>LDPRm</a>s.
        </p>
      </section>

      <section>
        <h2>HTTP POST</h2>
        <p>
          An implementation MUST NOT support <code>POST</code> for <a>LDPRm</a>s.
        </p>
      </section>

      <section>
        <h2>HTTP PUT</h2>
        <p>
           An implementation MUST NOT support <code>PUT</code> for <a>LDPRm</a>s.
        </p>
      </section>

    </section>

    <section>
      <h2>Version Containers (<a>LDPCv</a>)</h2>
      <section>
        <h2>General</h2>
        <p>
When a <a>LDPR</a> is created with a <code>Link</code> header indicating versioning, a version container (<a>LDPCv</a>) is created that contains Memento-identified resources (<a>LDPRm</a>) capturing time-varying states of the associated <a>LDPR</a>. The <a>LDPCv</a> is both a <a>TimeMap</a> per [[!RFC7089]] (Memento) and an LDP Container. An implementation MUST indicate <a>TimeMap</a> in the same way it indicates the Container interaction model of the resource (e.g. via HTTP headers or inserted <code>rdf:type</code>). An <a>LDPCv</a> MUST respond to <code>GET Accept: application/link-format</code> as indicated in [[!RFC7089]] <a href='https://tools.ietf.org/html/rfc7089#section-5'>section 5</a> and specified in [[RFC6690]] <a href='https://tools.ietf.org/html/rfc6690#section-7.3'>section 7.3</a>.
        </p>
		<p>
		An implementation MUST NOT allow any <a>LDPCv</a> to be LDP-contained by its associated <a>LDPRv</a>.
		</p>
        <p>
Non-normative: The <code>application/link-format</code> representation of a <a>LDPCv</a> is not required to include all statements in the <a>LDPCv</a> graph, only those required by <a>TimeMap</a> behaviors.
        </p>
      </section>

      <section>
        <h2 id='ldpcvdelete'>HTTP DELETE</h2>
        <p>
An implementation MAY support <code>DELETE</code>. An implementation that does support <code>DELETE</code> SHOULD do so by both removing the <a>LDPCv</a> and removing the versioning interaction model from the original <a>LDPRv</a>.
        </p>
      </section>

      <section>
        <h2>HTTP GET</h2>
        <section>
          <h2>HTTP Response Headers</h2>
          <p>
<code>Link@rel="type"</code> to indicate Timemap
          </p>
        </section>
      </section>


      <section>
        <h2>HTTP OPTIONS</h2>
        <p>
An implementation MUST <code>Allow: GET, HEAD, OPTIONS</code> as per [[!LDP]]. An implementation MAY <code>Allow: DELETE</code> if the versioning behavior is removable by deleting the <a>LDP-Cv</a>. See <a href='#ldpcvdelete'></a> for requirements on DELETE if supported.
An implementation MAY <code>Allow: PATCH</code> if the <a>LDPCv</a> has mutable properties. See <a href='#ldpcvpatch'></a> for requirements on <code>PATCH</code> if supported.
An implementation MAY <code>Allow: POST</code> if versions can be explicitly minted by a client. See <a href='#ldpcvpost'></a> for requirements on <code>POST</code> if supported.
        </p>
      </section>

      <section>
        <h2 id='ldpcvpatch'>HTTP PATCH</h2>
        <p>
An implementation MAY <code>Allow: PATCH</code>, but if so, it MUST NOT permit clients to modify containment triples.
        </p>
      </section>

      <section>
        <h2 id='ldpcvpost'>HTTP POST</h2>
        <p>
OPTIONAL. If a <a>LDPCv</a> Allow: POST, POST should be understood to create a new <a>LDPRm</a> contained by the <a>LDPCv</a>, reflecting the state of the <a>LDPRv</a> at the time of the POST. If supported, and all <a>LDPRm</a> statements are server-managed, Accept-Post SHOULD indicate that no request body is accepted ("Accept-Post: */*; p=0.0" has minimal conflict with LDP), and POST with a request body SHOULD respond with 4xx and a link to an appropriate constraints document (see <a href='https://www.w3.org/TR/ldp/#h-ldpr-gen-pubclireqs'>LDP 4.2.1.6</a>). As per LDP, any resource created via POST, in this case a <a>LDPRm</a>) should be advertised in the response's Location header.
        </p>
        <p>
If a <a>LDPCv</a> accepts POST with a request body, it SHOULD respect a Memento-Datetime request header to mint the <a>URI-M</a>. Absent this header, it MUST use the current time.          
        </p>
        <p>
Non-normative note: If <a>LDPCv</a> implementations do not <code>Allow: POST</code>, the constraints document indicated in <code>Link@rel="constrainedby"</code> for the <a>LDPCv</a> should describe the versioning mechanism. Disallowing POST suggests that the [[LDP]] server will manage all <a>LDPRm</a> creation; see <a href ="#server-managed">here</a>.
        </p>
      </section>

      <section>
        <h2>HTTP PUT</h2>
        <p>
OPTIONAL. If an implementation accepts PUT, it SHOULD reject created URIs that are not <a>URI-m</a>. It MUST respond to rejected request bodies as specified in LDP. <a>LDP-Cv</a> MUST reflect the range of times indicated by contained <a>LDP-Rm</a>.
        </p>
        <p>
Non-normative: An implementation that accepts PUT is not required to validate content.
        </p>
      </section>

    </section>

    <section>
      <h2 class='informative'>Vary-Post/Vary-Put</h2>
      <p>
When Post/Put to a resource optionally mints an identified version, the resource indicates it with Vary-Post/Vary-Put with the name of the request header indicating it. When a <a>LDP-Cv</a> supports Post/Put with a body, and allows client-specification of <a>URI-M</a> datetime, Vary-Post/Vary-Put: Memento-Datetime.
      </p>
    </section>

    <section>
      <h2 class='informative'>Implementation Patterns</h2>

      <section>
        <h2>Introduction</h2>
        <p>
This is a non-normative section describing the way the normative specification might be applied to implement discoverable versioning patterns. If an implementation of a <a>LDPCv</a> does not support POST to mint versions, that MUST be advertised via <code>OPTIONS</code>. Presumably the implementation would automatically mint versions, but that is outside this specification. This document specifies normatively only how <a>LDPCv</a>s and <a>LDPRm</a>s can be discovered, and how they should act.
        </p>
      </section>

      <section>
        <h2><a>LDPRm</a> Creation Patterns</h2>
        <section id="server-managed">
          <h2>Server-Managed Version Creation</h2>
          <p>
Upon <code>PUT/PATCH</code> to the <a>LDPRv</a>, a new <a>LDPRm</a> is created in an appropriate <a>LDPCv</a>. This <a>LDPRm</a>/<a>URI-M</a> is the version of the original <a>LDP-R</a>/<a>URI-R</a> that was just created.
          </p>
        </section>
        <section>
          <h2>Client-Managed Version Creation</h2>
          <p>
A <a>LDPRm</a> is created on <code>POST</code> to some <a>LDPCv</a>, <i>with an entity body</i>.  This pattern is more open to manipulation and could be useful for migration from other systems into Fedora Versioning systems.
          <p>
Responses from <code>GET</code> requests to the <a>LDP-R</a>/<a>URI-R</a> include a <code>Link@rel=’version-history’</code> pointing to the <a>LDP-Cv</a> as well as a <code>Link@rel="timemap"</code> to the same <a>LDP-Cv</a>.
          </p>
        </section>

      </section>

      <section>
        <h2>LDP Considerations</h2>
        <p>
Advertising default behaviors in server constraints document
        </p>
        <p>
If the [[LDP]] server allows reuse of URIs after deletion
Does this undermine the meaning of the version history?          
        </p>
        <p>
<a>LDPCv</a> as a DirectContainer
Minimizing header inspection for read-only clients with http://purl.org/dc/terms/hasVersion or similar.          
        </p>
      </section>

      <section>
        <h2>Memento Considerations</h2>
        <p>
If the <a>LDPCv</a>/<a>TimeMap</a> is also the <a>TimeGate</a> Responses from <code>GET</code> requests to the version container (<a>LDPCv</a>) will vary depending on the presence or absence of an Accept-Datetime header in the request.
          <ul>
            <li>
              In the absence of an Accept-Datetime header, the response will be an appropriately constructed <a>TimeMap</a>.
            </li>
            <li>
              In the presence of  an Accept-Datetime header, the response will be a redirect to the appropriately chosen <a>LDPRm</a>/<a>URI-M</a>, i.e. the version container will behave like a <a>TimeGate</a>.
            </li>
          <ul>
        </p>
      </section>

    </section>

    <section class='appendix'>
      <h2>Acknowledgments</h2>
      <p>
Thanks to Aaron Birkland, Adam Soroka, Andrew Woods, Anonymous, Ben Armintor ,Bethany Seeger, Jared Whiklo, Joshua Westgard, LDP-Next, Rob Sanderson, Sergio Fernández, Tom Johnson
      </p>
    </section>

  </body>
</html>
